// 2048 Clone - vanilla JS
const SIZE=4;const CELL_GAP=12;const gridEl=document.getElementById('grid');const scoreEl=document.getElementById('score');const bestEl=document.getElementById('best');const newGameBtn=document.getElementById('newGame');const undoBtn=document.getElementById('undo');let board=[];let tiles=[];let score=0;let best=0;let previousState=null;function init(){gridEl.innerHTML='';board=Array.from({length:SIZE},()=>Array(SIZE).fill(0));score=0;loadBest();createEmptyCells();addRandomTile();addRandomTile();render();attachEvents();saveState()}function createEmptyCells(){for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){const el=document.createElement('div');el.className='cell';gridEl.appendChild(el)}}}function cellPosition(row,col){const rect=gridEl.getBoundingClientRect();const width=rect.width;const totalGap=(SIZE-1)*CELL_GAP;const cellSize=(width-totalGap-32)/SIZE;const left=16+col*(cellSize+CELL_GAP);const top=16+row*(cellSize+CELL_GAP);return{left,top,size:cellSize}}function render(){tiles.forEach(t=>t.el.remove());tiles=[];for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){const val=board[r][c];if(val!==0){const pos=cellPosition(r,c);const el=document.createElement('div');el.className=`tile n${val}`;el.textContent=val;el.style.left=pos.left+'px';el.style.top=pos.top+'px';el.style.width=pos.size+'px';el.style.height=pos.size+'px';el.classList.add('new');gridEl.appendChild(el);tiles.push({r,c,val,el});requestAnimationFrame(()=>el.classList.remove('new'))}}}scoreEl.textContent=score;bestEl.textContent=best}function emptyCells(){const arr=[];for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){if(board[r][c]===0)arr.push({r,c})}}return arr}function addRandomTile(){const empties=emptyCells();if(empties.length===0)return false;const pick=empties[Math.floor(Math.random()*empties.length)];board[pick.r][pick.c]=Math.random()<0.9?2:4;return true}function copyBoard(b){return b.map(r=>r.slice())}function saveState(){previousState={board:copyBoard(board),score}}function undo(){if(!previousState)return;board=copyBoard(previousState.board);score=previousState.score;render();saveBest()}function slide(row){const arr=row.filter(v=>v!==0);const missing=SIZE-arr.length;const zeros=Array(missing).fill(0);return arr.concat(zeros)}function combine(row){for(let i=0;i<SIZE-1;i++){if(row[i]!==0&&row[i]===row[i+1]){row[i]*=2;row[i+1]=0;score+=row[i];if(score>best){best=score;saveBest()}}}return row}function moveLeft(){let moved=false;for(let r=0;r<SIZE;r++){const original=board[r].slice();let row=slide(board[r]);row=combine(row);row=slide(row);board[r]=row;if(!moved&&row.some((v,i)=>v!==original[i]))moved=true}return moved}function rotateCW(mat){const m=Array.from({length:SIZE},()=>Array(SIZE).fill(0));for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){m[c][SIZE-1-r]=mat[r][c]}}return m}function rotateCCW(mat){const m=Array.from({length:SIZE},()=>Array(SIZE).fill(0));for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){m[SIZE-1-c][r]=mat[r][c]}}return m}function move(direction){saveState();let moved=false;if(direction==='left'){moved=moveLeft()}else if(direction==='right'){for(let r=0;r<SIZE;r++)board[r].reverse();moved=moveLeft();for(let r=0;r<SIZE;r++)board[r].reverse()}else if(direction==='up'){board=rotateCW(board);moved=moveLeft();board=rotateCCW(board)}else if(direction==='down'){board=rotateCCW(board);moved=moveLeft();board=rotateCW(board)}if(moved){addRandomTile();render();if(checkGameOver()){setTimeout(()=>alert('Game Over!'),50)}}else{previousState=null}}function checkGameOver(){if(emptyCells().length>0)return false;for(let r=0;r<SIZE;r++){for(let c=0;c<SIZE;c++){const v=board[r][c];if((c<SIZE-1&&v===board[r][c+1])||(r<SIZE-1&&v===board[r+1][c]))return false}}return true}function loadBest(){try{const b=localStorage.getItem('2048_best');best=b?Number(b):0}catch(e){best=0}}function saveBest(){try{localStorage.setItem('2048_best',String(best))}catch(e){}}function attachEvents(){window.addEventListener('keydown',(e)=>{if(e.key==='ArrowLeft'){move('left');e.preventDefault()}if(e.key==='ArrowRight'){move('right');e.preventDefault()}if(e.key==='ArrowUp'){move('up');e.preventDefault()}if(e.key==='ArrowDown'){move('down');e.preventDefault()}if(e.key==='z'&&(e.ctrlKey||e.metaKey)){undo()}});let startX=null,startY=null;gridEl.addEventListener('touchstart',(e)=>{const t=e.touches[0];startX=t.clientX;startY=t.clientY},{passive:true});gridEl.addEventListener('touchend',(e)=>{if(startX===null)return;const t=(e.changedTouches&&e.changedTouches[0])||e;const dx=t.clientX-startX;const dy=t.clientY-startY;if(Math.abs(dx)>Math.abs(dy)){if(dx>30)move('right');else if(dx<-30)move('left')}else{if(dy>30)move('down');else if(dy<-30)move('up')}startX=null;startY=null},{passive:true});newGameBtn.addEventListener('click',init);undoBtn.addEventListener('click',()=>{undo();render()});window.addEventListener('resize',()=>render())}init();
